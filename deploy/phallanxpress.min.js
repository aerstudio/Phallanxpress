((function(){var a,b,c,d,e,f,g,h=function(a,b){return function(){return a.apply(b,arguments)}},i=Object.prototype.hasOwnProperty,j=function(a,b){function d(){this.constructor=a}for(var c in b)i.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};f=this,e=f.Phallanxpress,typeof exports!="undefined"?(c=exports.Phallanxpress={},d=!1):(c=f.Phallanxpress={},d=!0),c.VERSION="0.1.0",g=f._,!g&&typeof require!="undefined"&&(g=require("underscore")),b=f.Backbone,!b&&typeof require!="undefined"&&(b=require("backbone")),a=f.jQuery||f.Zepto||f.ender,c.noConflict=function(){return f.Phallanxpress=e,this},c.Storage=function(){function a(a){this.name=a,this.enable()}return a.prototype.expireTime=24,a.prototype.enable=function(){if(typeof window!="undefined"&&window!==null)return this.storage=window.localStorage},a.prototype.disable=function(){return this.storage=null},a.prototype.saveCollection=function(a){var b;if(a.length===0||this.storage==null)return;b={ids:a.pluck("id"),timestamp:(new Date).getTime()};try{this.storage.setItem(a.url,JSON.stringify(b))}catch(c){if(c===QUOTA_EXCEEDED_ERR)return;throw c}return a.each(h(function(a){return this.saveModel(a)},this))},a.prototype.saveModel=function(a){var b;if(this.storage==null)return;b=new Date,a.set({phallanxTimestamp:b.getTime(),silent:!0});try{return this.storage.setItem(this.name+a.constructor.name.toLowerCase()+"/"+a.id,JSON.stringify(a))}catch(c){if(c!==QUOTA_EXCEEDED_ERR)throw c}},a.prototype.getCollection=function(a){var b,c,d,e;return this.storage==null?!1:(b=JSON.parse(this.storage.getItem(a.url)),b!=null?(c=(new Date).getTime()-b.timestamp,c<this.expireTime*36e5?(d=(new a.model).constructor.name,e=g.map(b.ids,h(function(a){var b;return b=this.getModelAttributes(a,d)},this)),a.options.add?a.add(e,{silent:!0}):a.reset(e,{silent:!0}),!0):(this.destroyCollection(a),!1)):!1)},a.prototype.getModel=function(a){var b,c,d;return b=this.getModelAttributes(a.id,a.constructor.name),b==null&&this.storage==null?!1:b.phallanxTimestamp!=null?(d=+b.phallanxTimestamp||0,delete b.phallanxTimestamp,c=(new Date).getTime()-d,c<this.expireTime*36e5?(a.set(b,{silent:!0}),!0):!1):!1},a.prototype.getModelAttributes=function(a,b){return JSON.parse(this.storage.getItem(this.name+b.toLowerCase()+"/"+a))},a.prototype.destroyCollection=function(a){if(this.storage==null)return;return this.storage.removeItem(a.url)},a}(),c.Api=function(){function d(b){var d,e,f;this.url=b;if(this.url==null)throw new Error("URL must be defined");this.url.slice(-1)!=="/"&&(this.url+="/"),typeof window!="undefined"&&window!==null&&(d=document.createElement("a"),d.href=this.url,e='<link rel="dns-prefetch" href="'+d.protocol+"//"+d.hostname+'">',f=a('link[href*="'+d.protocol+"//"+d.hostname+'"][rel=dns-prefetch]'),f.length===0&&a("head").append(e)),this.cache=new c.Storage(this.url)}return d.prototype.recentPosts=function(a){var b,d;return a||(a={}),b=new c.Posts,b.api=this,d=this._bindView(b,a.view),b.recentPosts(a),d!=null?d:b},d.prototype.searchPosts=function(a,b){var d,e;return b||(b={}),d=new c.Posts,d.api=this,e=this._bindView(d,b.view),d.searchPosts(a,b),e!=null?e:d},d.prototype.datePosts=function(a,b){var d,e;return b||(b={}),d=new c.Posts,d.api=this,e=this._bindView(d,b.view),d.datePosts(a,b),e!=null?e:d},d.prototype.post=function(a,b){var d,e;b||(b={}),d=new c.Post,d.api=this;if(g.isNumber(a))d.id=a;else{if(!g.isString(a))throw new Error("id must be a number or a string for a slug");d.set({slug:a})}return e=this._bindView(d,b.view),b.postType!=null&&(d.postType=b.postType),d.fetch(b),e!=null?e:d},d.prototype.pageList=function(a){var b,d;return a||(a={}),b=new c.Pages,b.api=this,d=this._bindView(b,a.view),b.pageList(a),d!=null?d:b},d.prototype.page=function(a,b){var d,e;b||(b={}),d=new c.Page,d.api=this;if(g.isNumber(a))d.id=a;else{if(!g.isString(a))throw new Error("id must be a number or a string for a slug");d.set({slug:a})}return e=this._bindView(d,b.view),d.fetch(b),e!=null?e:d},d.prototype.categoryList=function(a){var b,d;return a||(a={}),b=new c.Categories,b.api=this,d=this._bindView(b,a.view),b.categoryList(a),d!=null?d:b},d.prototype.categoryPosts=function(a,b){var d,e;return b||(b={}),d=new c.Posts,d.api=this,e=this._bindView(d,b.view),d.categoryPosts(a,b),e!=null?e:d},d.prototype.tagList=function(a){var b,d;return a||(a={}),b=new c.Tags,b.api=this,d=this._bindView(b,a.view),b.tagList(a),d!=null?d:b},d.prototype.tagPosts=function(a,b){var d,e;return b||(b={}),d=new c.Posts,d.api=this,e=this._bindView(d,b.view),d.tagPosts(a,b),e!=null?e:d},d.prototype.authorList=function(a){var b,d;return a||(a={}),b=new c.Authors,b.api=this,d=this._bindView(b,a.view),b.authorList(a),d!=null?d:b},d.prototype.authorPosts=function(a,b){var d,e;return b||(b={}),d=new c.Posts,d.api=this,e=this._bindView(d,b.view),d.authorPosts(a,b),e!=null?e:d},d.prototype._bindView=function(a,c){var d;if(c!=null){if(c instanceof b.View)d=c,a instanceof b.Collection?(d.obj=a,g.isFunction(d.render)&&(a.on("reset",d.render,d),a.on("add",d.render,d))):(d.model=a,g.isFunction(d.render)&&a.on("change",d.render,d));else{if(!g.isFunction(c))return null;a instanceof b.Collection?d=new c({collection:a}):d=new c({model:a})}return d}return null},d}(),c.Model=function(){function a(){a.__super__.constructor.apply(this,arguments)}return j(a,b.Model),a.prototype.url=function(){var a,b;if(this.apiCommand==null)throw new Error("An api command must be defined");if(this.apiUrl==null&&this.api==null)throw new Error("An api or apiUrl must be defined");return a=this.apiUrl||this.api.url,this.id!=null?b=""+a+this.apiCommand+"/?id="+this.id:this.has("slug")&&(b=""+a+this.apiCommand+"/?slug="+this.get("slug")),this.postType!=null&&(b+="&post_type=#{@post_type}"),this.taxonomy!=null&&(b+="&taxonomy=@{@taxonomy}"),b},a.prototype.fetch=function(b){var c,d;return b=b||{},d=b.forceRequest||!1,this.api!=null&&!d&&(c=this.api.cache.getModel(this)),c?(b.silent||this.trigger("change",this,b),b.success!=null&&b.success(this,null)):a.__super__.fetch.apply(this,arguments),this},a.prototype.parse=function(a,b){return a.status==="ok"?g.isEmpty(this.parseTag)?a:a[this.parseTag]:a},a.prototype.save=function(){},a}(),c.Tag=function(){function a(){a.__super__.constructor.apply(this,arguments)}return j(a,c.Model),a}(),c.Category=function(){function a(){a.__super__.constructor.apply(this,arguments)}return j(a,c.Model),a.prototype.children=function(){return this.collection.filter(h(function(a){return a.get("parent")===this.id},this))},a}(),c.Post=function(){function a(){a.__super__.constructor.apply(this,arguments)}return j(a,c.Model),a.prototype.apiCommand="get_post",a.prototype.parseTag="post",a}(),c.Page=function(){function a(){a.__super__.constructor.apply(this,arguments)}return j(a,c.Model),a.prototype.apiCommand="get_page",a.prototype.parseTag="page",a}(),c.Author=function(){function a(){a.__super__.constructor.apply(this,arguments)}return j(a,c.Model),a}(),c.Collection=function(){function c(){c.__super__.constructor.apply(this,arguments)}return j(c,b.Collection),c.prototype.getBySlug=function(a){var b;b=this.filter(function(b){return b.get("slug")===a});switch(b.length){case 1:return b[0];case 0:return null;default:throw new Error("More than one post with the same slug")}},c.prototype._wpAPI=function(b,c){var d,e,f,i,j,k;if(b==null)throw new Error("An api command must be defined");if(this.apiUrl==null&&this.api==null)throw new Error("An api or apiUrl must be defind");return this.isLoading=!0,c=c&&g.clone(c)||{},k=this.apiUrl||this.api.url,k+=b+"/",c.params=c.params||{},this.currentCommand=b,f=c.postType||this.postType,f!=null&&(c.params.post_type=f),this.customFields&&(c.params.custom_fields=this.customFields),j=c.taxonomy||this.taxonomy,j&&(c.params.taxonomy=j),g.isEmpty(c.params)||(k+="?"+a.param(c.params)),this.currentParams=c.params,this.url=k,i=c.success,c.success=h(function(a,b,c){this.isLoading=!1,this.api!=null&&this.api.cache.saveCollection(this);if(i!=null)return i(this,a)},this),this.options=g.clone(c),delete this.options.success,d=!1,e=c.forceRequest||!1,this.api!=null&&!e&&(d=this.api.cache.getCollection(this)),d?(c.silent||(c.add?this.trigger("add",this,c):this.trigger("reset",this,c)),i!=null&&i(this,null)):(c.add||this.reset(),this.fetch(c)),this},c.prototype.resetVars=function(){return this.page=this.pages=this.count=this.count_total=null},c.prototype.parse=function(a,b){return a.status==="ok"?a[this.parseTag]:(this.trigger("error",a.error,a,b),null)},c.prototype.save=function(){},c}(),c.Categories=function(){function a(){a.__super__.constructor.apply(this,arguments)}return j(a,c.Collection),a.prototype.model=c.Category,a.prototype.parseTag="categories",a.prototype.categoryList=function(a){return this._wpAPI("get_category_index",a)},a.prototype.topCategories=function(){var a;return a=this.filter(function(a){return a.get("parent")===0}),new c.Categories(a)},a}(),c.Pages=function(){function a(){a.__super__.constructor.apply(this,arguments)}return j(a,c.Collection),a.prototype.model=c.Page,a.prototype.parseTag="pages",a.prototype.pageList=function(a){return this._wpAPI("get_page_index",a)},a}(),c.Posts=function(){function a(){a.__super__.constructor.apply(this,arguments)}return j(a,c.Collection),a.prototype.model=c.Post,a.prototype.parseTag="posts",a.prototype.defaultCount=32,a.prototype.recentPosts=function(a){return this._wpAPI("get_recent_posts",this._pageOptions(null,a))},a.prototype.categoryPosts=function(a,b){return this._wpAPI("get_category_posts",this._pageOptions(a,b))},a.prototype.authorPosts=function(a,b){return this._wpAPI("get_author_posts",this._pageOptions(a,b))},a.prototype.tagPosts=function(a,b){return this._wpAPI("get_tag_posts",this._pageOptions(a,b))},a.prototype.searchPosts=function(a,b){return b=this._pageOptions(null,b),b.params.search=a,this._wpAPI("get_search_results",b)},a.prototype.datePosts=function(a,b){return b=this._pageOptions(null,b),b.params.date=a,this._wpAPI("get_date_posts",b)},a.prototype.pageUp=function(a){return this.toPage(this.page+1,a)},a.prototype.pageDown=function(a){return this.toPage(this.page-1,a)},a.prototype.toPage=function(a,b){return b=b&&g.clone(b)||{},this.options!=null&&(b=g.defaults(b,this.options)),a!=null&&a>=1&&(this.pages==null||a<=this.pages)?(b.page=a,this._wpAPI(this.currentCommand,this._pageOptions(this.apiObject,b))):!1},a.prototype._pageOptions=function(a,b){return b=b&&g.clone(b)||{},b.params=b.params||{},a!=null&&(this.apiObject=a,g.isNumber(a)?b.params.id=a:g.isString(a)?b.params.slug=a:a.id!=null&&(b.params.id=a.id)),b.params.count=b.count||this.defaultCount,this.page=b.page||1,b.params.page=this.page,b},a.prototype.parse=function(a,b){return a.status==="ok"?(this.count_total=a.count_total,this.pages=a.pages,this.count=a.count,this.count_total===0?(this.trigger("no posts",a,b),null):a.posts):(this.trigger("error",a.error,a,b),null)},a}(),c.Tags=function(){function a(){a.__super__.constructor.apply(this,arguments)}return j(a,c.Collection),a.prototype.model=c.Tag,a.prototype.parseTag="tags",a.prototype.tagList=function(a){return this._wpAPI("get_tag_index",a)},a}(),c.Authors=function(){function a(){a.__super__.constructor.apply(this,arguments)}return j(a,c.Collection),a.prototype.model=c.Author,a.prototype.parseTag="authors",a.prototype.authorList=function(a){return this._wpAPI("get_author_index",a)},a}()})).call(this)